# Buddy Migration Spec: Next.js + React Router → TanStack Router + Hono

## Architecture

```
Current:  Next.js 16 → SPA rewrite → React Router 7 → Client rendering
                    → /api/completion (AI streaming)

Target:   Vite SPA → TanStack Router (client routing)
          Hono API → /api/completion (AI streaming) → Vercel Serverless
```

**No SSR.** Client-side rendering only. Hono handles the single API endpoint.

---

## Decisions

| Decision               | Choice                                              |
| ---------------------- | --------------------------------------------------- |
| Package manager        | npm                                                 |
| Query params           | Keep `nuqs` with `nuqs/adapters/tanstack-router`    |
| Route file style       | Flat (`investments.tsx`, `investments.$id.tsx`, etc.) |
| API structure          | Single Hono file for `/api/completion`               |
| Dev setup              | Unified (Vite dev server + Hono via vite plugin)     |
| Env var prefix         | `VITE_` for client, bare for server                  |
| Scope                  | Pure 1:1 migration                                   |
| Remove unused deps     | Yes (zustand, next, react-router, eslint-config-next)|
| Testing                | None to migrate                                      |

---

## File Mapping

### Delete (Next.js-specific)

```
src/app/                          # Entire Next.js app directory
  layout.tsx                      # → theme moves to src/theme.ts, shell to src/routes/__root.tsx
  globals.css                     # → moves to src/globals.css
  static-app-shell/page.tsx       # → replaced by Vite SPA entry point
  api/completion/route.ts         # → moves to src/api/completion.ts (Hono)
src/routes/app.tsx                # → replaced by TanStack file-based routing
src/components/hydration-boundary.tsx  # → delete (no-op component)
next.config.mjs                   # → replaced by vite.config.ts
next-env.d.ts                     # → delete
```

### Create (New files)

```
index.html                        # Vite SPA entry point
vite.config.ts                    # Vite + TanStack Router plugin config
vercel.json                       # Route SPA fallback + API rewrites
src/main.tsx                      # React DOM render entry
src/router.tsx                    # TanStack Router instance
src/theme.ts                      # Mantine theme (extracted from layout.tsx)
src/routeTree.gen.ts              # Auto-generated by TanStack Router
src/api/completion.ts             # Hono API handler
```

### Convert (React Router → TanStack Router)

```
src/routes/app.tsx                → src/routes/__root.tsx          (root layout)
src/routes/layout.tsx             → merged into __root.tsx         (app shell)
src/routes/home-page.tsx          → src/routes/index.tsx
src/routes/expenses-page.tsx      → src/routes/expenses.tsx
src/routes/incomes-page.tsx       → src/routes/incomes.tsx
src/routes/accounts-page.tsx      → src/routes/accounts.tsx
src/routes/settings-page.tsx      → src/routes/settings.tsx
src/routes/investments-page.tsx   → src/routes/investments.index.tsx
src/routes/new-investment-page.tsx    → src/routes/investments.new.tsx
src/routes/investment-detail-page.tsx → src/routes/investments.$id.tsx
src/routes/edit-investment-page.tsx   → src/routes/investments.$id.edit.tsx
```

### Update (Import changes only)

Files that import from `react-router` or use `'use client'`:

```
src/components/navigation.tsx          # NavLink → Link, useLocation → useRouterState
src/components/app-header.tsx          # useLocation → useRouterState
src/components/expense-overview.tsx    # NavLink → Link
src/components/income-overview.tsx     # NavLink → Link
src/components/investment/investment-card.tsx  # Link import
src/components/investment/forms/investment-form.tsx  # useNavigate
src/routes/investment-detail-page.tsx  # Link, useNavigate, useParams
src/routes/edit-investment-page.tsx    # Link, useNavigate, useParams
src/routes/new-investment-page.tsx     # Link
src/routes/investments-page.tsx        # Link
```

### Unchanged

```
src/stores/instantdb.ts               # No framework deps
src/contexts/header-action-context.tsx # Pure React context
src/hooks/use-dashboard-export.ts      # No framework deps
src/hooks/use-shared-query-params.ts   # Update nuqs adapter import only
src/utils/csv-export.ts               # Pure utility
src/components/ (remaining ~35 files)  # Remove 'use client' directives, otherwise identical
```

---

## Detailed Migration Steps

### Step 1: Project Configuration

**package.json** — Remove:
- `next`, `eslint-config-next`, `react-router`, `zustand`

**package.json** — Add:
- `@tanstack/react-router`, `@tanstack/react-router-vite-plugin`
- `hono`
- `vite`, `@vitejs/plugin-react`, `vite-tsconfig-paths`

**package.json** — Update scripts:
```json
{
  "dev": "vite",
  "build": "vite build",
  "preview": "vite preview",
  "lint": "eslint src/"
}
```

**vite.config.ts**:
```ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import { TanStackRouterVite } from '@tanstack/react-router-vite-plugin'
import tsconfigPaths from 'vite-tsconfig-paths'

export default defineConfig({
  plugins: [
    tsconfigPaths(),
    TanStackRouterVite(),
    react(),
  ],
  server: { port: 3000 },
})
```

**index.html** (Vite SPA entry):
```html
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Buddy</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

**tsconfig.json** — Remove Next.js plugin, update includes.

**vercel.json**:
```json
{
  "rewrites": [
    { "source": "/api/(.*)", "destination": "/api/$1" },
    { "source": "/((?!api/).*)", "destination": "/index.html" }
  ]
}
```

### Step 2: Entry Points

**src/main.tsx**:
```tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { RouterProvider } from '@tanstack/react-router'
import { MantineProvider, ColorSchemeScript } from '@mantine/core'
import { Notifications } from '@mantine/notifications'
import { theme } from './theme'
import { router } from './router'

import '@mantine/core/styles.css'
import '@mantine/dates/styles.css'
import '@mantine/notifications/styles.css'
import './globals.css'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <MantineProvider theme={theme} defaultColorScheme="light">
      <Notifications />
      <RouterProvider router={router} />
    </MantineProvider>
  </React.StrictMode>,
)
```

**src/router.tsx**:
```tsx
import { createRouter } from '@tanstack/react-router'
import { routeTree } from './routeTree.gen'

export const router = createRouter({ routeTree })

declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router
  }
}
```

**src/theme.ts** — Extract the `createTheme({...})` call from current `layout.tsx`.

### Step 3: Root Route

**src/routes/__root.tsx**:
```tsx
import { createRootRoute, Outlet } from '@tanstack/react-router'
import { NuqsAdapter } from 'nuqs/adapters/tanstack-router'
import { HeaderActionProvider } from '@/contexts/header-action-context'
import { DesktopNav, MobileNav } from '@/components/navigation'
import { AppHeader } from '@/components/app-header'
import { AppShell, Group, Box } from '@mantine/core'

export const Route = createRootRoute({
  component: RootLayout,
})

function RootLayout() {
  return (
    <NuqsAdapter>
      <HeaderActionProvider>
        <AppShell
          header={{ height: 60 }}
          navbar={{ width: 56, breakpoint: 'sm', collapsed: { mobile: true } }}
          footer={{ height: 'calc(64px + env(safe-area-inset-bottom, 0px))' }}
          padding="md"
          withBorder={false}
          styles={{ root: { backgroundColor: '#F8FAFB' } }}
        >
          <AppShell.Header style={{ backgroundColor: '#FFFFFF', borderBottom: '1px solid #E5E9EB' }}>
            <AppHeader />
          </AppShell.Header>
          <AppShell.Navbar style={{ backgroundColor: '#FFFFFF', borderRight: '1px solid #E5E9EB' }}>
            <DesktopNav />
          </AppShell.Navbar>
          <AppShell.Footer hiddenFrom="sm" style={{ backgroundColor: '#FFFFFF', borderTop: '1px solid #E5E9EB', display: 'flex', alignItems: 'flex-start', justifyContent: 'center', paddingBottom: 'env(safe-area-inset-bottom, 0px)' }}>
            <Group gap={0} h="100%" align="center" style={{ width: '100%' }}>
              <MobileNav />
            </Group>
          </AppShell.Footer>
          <AppShell.Main style={{ backgroundColor: '#F8FAFB' }}>
            <Box className="scrollable-zone" style={{ height: '100%' }}>
              <Outlet />
            </Box>
          </AppShell.Main>
        </AppShell>
      </HeaderActionProvider>
    </NuqsAdapter>
  )
}
```

### Step 4: Route Files

Each page becomes a TanStack route file. Pattern:

```tsx
// src/routes/expenses.tsx
import { createFileRoute } from '@tanstack/react-router'
import ExpensesPage from '@/components/expenses-page-content' // or inline

export const Route = createFileRoute('/expenses')({
  component: ExpensesPage,
})
```

For parameterized routes:
```tsx
// src/routes/investments.$id.tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/investments/$id')({
  component: InvestmentDetailPage,
})

function InvestmentDetailPage() {
  const { id } = Route.useParams()
  // ... existing component logic
}
```

### Step 5: React Router → TanStack Router API Mapping

| React Router                | TanStack Router                           |
| --------------------------- | ----------------------------------------- |
| `<BrowserRouter>`           | `<RouterProvider router={router}>`        |
| `<Route path="/" element>`  | `createFileRoute('/')({ component })`     |
| `<Link to="/foo">`          | `<Link to="/foo">`                        |
| `<NavLink to="/foo">`       | `<Link to="/foo">` + active state logic   |
| `useParams()`               | `Route.useParams()`                       |
| `useNavigate()`             | `useNavigate()` from `@tanstack/react-router` |
| `useLocation()`             | `useRouterState({ select: s => s.location })` |
| `navigate('/foo')`          | `navigate({ to: '/foo' })`               |

### Step 6: Navigation Component Updates

**navigation.tsx** changes:
```tsx
// Before
import { NavLink, useLocation } from 'react-router'
<NavLink to={{ pathname: item.href, search: `?month=${m}&year=${y}` }}>

// After
import { Link, useRouterState } from '@tanstack/react-router'
<Link to={item.href} search={{ month: m, year: y }}>
```

Active state detection:
```tsx
// Before
const pathname = location.pathname

// After
const pathname = useRouterState({ select: (s) => s.location.pathname })
```

### Step 7: nuqs Adapter Swap

**src/hooks/use-shared-query-params.ts**:
```tsx
// Only change: adapter import
// Before
import { NuqsAdapter } from 'nuqs/adapters/react-router/v7'
// After
import { NuqsAdapter } from 'nuqs/adapters/tanstack-router'
```

The `useQueryState` hook calls remain identical.

### Step 8: Hono API

**src/api/completion.ts**:
```ts
import { Hono } from 'hono'
import { google } from '@ai-sdk/google'
import { openai } from '@ai-sdk/openai'
import { streamObject } from 'ai'
import { z } from 'zod'

const app = new Hono()

// ... buildPrompt and expenseSchema stay identical ...

app.post('/api/completion', async (c) => {
  const { prompt, expenseCategories, historicalExpenses } = await c.req.json()

  // ... identical AI logic ...

  try {
    const result = streamObject({
      model: google('gemini-3-flash-preview'),
      output: 'array',
      schema: expenseSchema,
      prompt: promptContent,
      maxRetries: 2,
    })
    return result.toTextStreamResponse()
  } catch (geminiError) {
    const result = streamObject({
      model: openai('gpt-4o-mini'),
      output: 'array',
      schema: expenseSchema,
      prompt: promptContent,
      maxRetries: 2,
    })
    return result.toTextStreamResponse()
  }
})

export default app
```

**Vercel adapter** (`api/[[...route]].ts` or `api/index.ts`):
```ts
import { handle } from 'hono/vercel'
import app from '../src/api/completion'

export default handle(app)
```

### Step 9: Cleanup

Remove all `'use client'` directives from every file (Vite SPA doesn't use them).

Delete:
- `src/app/` directory entirely
- `src/routes/app.tsx`
- `src/components/hydration-boundary.tsx`
- `next.config.mjs`
- `next-env.d.ts`

### Step 10: Environment Variables

| Current                          | New                       |
| -------------------------------- | ------------------------- |
| `NEXT_PUBLIC_INSTANTDB_APP_ID`   | `VITE_INSTANTDB_APP_ID`   |
| `GOOGLE_API_KEY`                 | `GOOGLE_API_KEY` (same)   |
| `OPENAI_API_KEY`                 | `OPENAI_API_KEY` (same)   |

Update `src/stores/instantdb.ts` to read `import.meta.env.VITE_INSTANTDB_APP_ID`.

---

## Risk Items

1. **nuqs TanStack Router adapter** — Experimental. If issues arise, fallback is TanStack Router native `validateSearch` with a thin wrapper matching the nuqs API.
2. **Hono streaming on Vercel** — Vercel serverless supports streaming responses. The `maxDuration` config moves to `vercel.json` function config.
3. **Handsontable** — Pure client component, no framework deps. Should work unchanged.
4. **`maxDuration: 300`** — Currently exported from Next.js route. Needs equivalent in `vercel.json`:
   ```json
   { "functions": { "api/**": { "maxDuration": 300 } } }
   ```

---

## Validation Checklist

- [ ] All 11 routes render correctly
- [ ] Month/year query params persist across navigation (nuqs)
- [ ] AI expense categorization streams correctly
- [ ] Navigation active states work (desktop + mobile)
- [ ] Mantine theming renders correctly (no FOUC)
- [ ] InstantDB real-time data loads on all pages
- [ ] Investment detail/edit pages receive `$id` param
- [ ] CSV export works from dashboard
- [ ] Header action slot works (Export CSV, Add Investment buttons)
- [ ] Mobile responsive layout works
- [ ] Vercel deployment succeeds
